<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>המפוצל</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<style>
    body {
		/* margin: 1; */
		margin: 0;
		background-color: #000;
		display: grid;
		grid-template-columns: repeat(3, 1fr);
		grid-template-rows: repeat(3, 1fr);
		gap: 5px;
		padding-top: 60px;
		/* height: 100vh; */
		/* width: 100vw; */
		overflow: hidden;
    }
	
	.headline {
		color: white;
		text-align: right;
		font-family: Roboto, Helvetica, sans-serif;
		font-weight: bold;
		font-size: 15px;
		padding: 5px 0;
		padding-bottom: 20px;
		/* padding-right: 10px; */
    }
	
	.name {
		color: white;
		text-align: center;
		font-family: Roboto, Helvetica, sans-serif;
		font-weight: bold;
		font-size: 25px;
		padding: 10px 0;
		padding-right: 60px;
		position: absolute;
		top: 0;
		right: 0;
	}
	
    video {	  
		/* filter: grayscale(100%); */
		/* padding-left: 12.5px; */
		width: 100%;
		height: 100%;
		object-fit: cover;
		background-color: black;
		/*transition: transform 0.5s ease,filter 0.5s ease, opacity 0.5s ease;*/
		/*border-radius: 12.5px;*/
    }

	video:fullscreen {
		filter: none;
		border-radius: 0;
		transition: none;
	}
	
	/* video.audio-active .snapshot-canvas.active{
		filter: none;
		display: none;
	} */

	video.audio-active {
		filter: none;
		transition: filter 0.2s ease;

	}

	/* video.audio-active .video-wrapper{
		border-radius: 0;

	} */
    .stream-container {
		display: flex;
		flex-direction: column;
		width: 100%;
		height: 100%;
		position: relative;
		
    }

    #logo {
		position: absolute;
		top: 0;
		right: 0;
		height: 35px;
		padding: 8px 0;
    }
	
	.snapshot-canvas {
		/* filter: grayscale(100%); */
		/* padding-left: 12.5px; */
		overflow: hidden;
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		/*object-fit: cover;*/
		pointer-events: none;
		display: none;
		/*border-radius: 12.5px;*/

	}
	
	.snapshot-canvas.active {
		display: block;
		
	}
	/* .video-wrapper .snapshot-canvas.active{
		cursor: pointer
		
	} */
	/* .snapshot-canvas.border {
		border-radius: 0;
	} */
	
	/* .stream-container:hover .snapshot-canvas.active{
		border-radius: 0;
	} */
	
	/* .stream-container:hover video {
		border-radius: 0;
	}
	 */
	.stream-container:hover .video-wrapper {
		border-radius: 0;
	}
	.video-wrapper {
		position: relative;
		width: 100%;
		aspect-ratio: 16/9;
		overflow: hidden;
		border-radius: 12.5px;
	}
	.made-by {
		color: white;
		font-family: Helvetica;
		padding-left: 12.5px;
		font-size: 15px;
	}

</style>
</head>

<body>

<img id="logo" src="logo.png" alt="logo" /><div class="name">המפוצל</div>
<div class="stream-container"><div class="video-wrapper"><video id="video1" controls muted autoplay></video><canvas class="snapshot-canvas"></canvas></div><div class="headline">ערוץ 11</div></div>
<div class="stream-container"><div class="video-wrapper"><video id="video2" controls muted autoplay></video><canvas class="snapshot-canvas"></canvas></div><div class="headline">ערוץ 12️</div></div>
<div class="stream-container"><div class="video-wrapper"><video id="video3" controls muted autoplay></video><canvas class="snapshot-canvas"></canvas></div><div class="headline">ערוץ 13</div></div>
<div class="stream-container"><div class="video-wrapper"><video id="video4" controls muted autoplay></video><canvas class="snapshot-canvas"></canvas></div><div class="headline">ערוץ 14️</div></div>
<div class="stream-container"><div class="video-wrapper"><video id="video5" controls muted autoplay></video><canvas class="snapshot-canvas"></canvas></div><div class="headline">ערוץ 15</div></div>
<div class="stream-container"><div class="video-wrapper"><video id="video6" controls muted autoplay></video><canvas class="snapshot-canvas"></canvas></div><div class="headline">הכנסת</div></div>
<!-- <div class="made-by">Made With 🧡 By Alon (Blademind)</div> -->
<script>
const tv11 = "https://kan11w.media.kan.org.il/hls/live/2105694/2105694/source1_4k/chunklist.m3u8";
const tv12 = "https://mako-streaming.akamaized.net/stream/hls/live/2033791/k12dvr/profile/5/hdntl=exp=1752685453~acl=%2f*~data=hdntl~hmac=65a29d1cefeb7f670c67a1920be1068b2ef2477179e3d63024cd714b6fafdca1/profileManifest.m3u8?_uid=71004289-468b-4ec1-9aa4-b6e669677fc6&rK=b2&_did=f992ce22-2614-4415-9082-f2f4e011b671"
//const tv12 = "https://mako-streaming.akamaized.net/stream/hls/live/2033791/k12dvr/profile/5/hdntl=exp=1752685453~acl=%2f*~data=hdntl~hmac=65a29d1cefeb7f670c67a1920be1068b2ef2477179e3d63024cd714b6fafdca1/profileManifest.m3u8?_uid=71004289-468b-4ec1-9aa4-b6e669677fc6&rK=b2&_did=f992ce22-2614-4415-9082-f2f4e011b671";
const tv13 = "https://reshet.g-mana.live/media/87f59c77-03f6-4bad-a648-897e095e7360/mainManifest.m3u8";
const tv14 = "https://n-121-6.il.cdn-redge.media/livehls/oil/ch14/live/ch14/live.livx/playlist.m3u8";
const tv15 = "https://bcovlive-a.akamaihd.net/d89ede8094c741b7924120b27764153c/eu-central-1/5377161796001/profile_0/chunklist.m3u8";
const knesset = "https://kneset.gostreaming.tv/p2-kneset/_definst_/myStream/chunklist.m3u8"
const fox = "http://23.237.104.106:8080/USA_FOX_NEWS/index.m3u8"

const lst = [tv11, tv12, tv13,tv14, tv15, knesset];

function attachStream(video,i){
    if (Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(lst[i]);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, function() {
            video.play();
        });
		
    }
}

function reloadStream(video,i) {
    console.log('Reloading stuck video:', video.id);
    if (video.hlsInstance) {
        video.hlsInstance.destroy();
    }
    attachStream(video,i);
}

function updateAudioStatus(video) {
	const video_wrapper = video.closest('.video-wrapper');
	const isAudioActive = !video.muted && video.volume > 0;
	if (isAudioActive) {
		video_wrapper.style.borderRadius  = "0px"
		video.classList.add('audio-active');
	} 
	else {
		video_wrapper.style.borderRadius  = "12.5px"
		video.classList.remove('audio-active');
	}
}

function captureFrame(container,canvas,video) {
	const ctx = canvas.getContext('2d');
	const isPlayingAudio = !video.muted && video.volume > 0;
	if (!container.matches(':hover') && !isPlayingAudio) {
		container.style.cursor = 'pointer';
		canvas.classList.add('active');
		try {
			ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
		} 
		catch (e) {
			console.warn('Draw failed:', e);
		}

	} 
	else {
		container.style.cursor = '';
	  	canvas.classList.remove('active'); // reveal full video
	}
}

const THROTTLE_INTERVAL  = 60000; // milliseconds

for (let i = 0; i < 6; i++) {
    const video = document.getElementById(`video${i+1}`);
	attachStream(video,i);
	video.volume = 0.03;
	updateAudioStatus(video);
	['volumechange', 'mouseenter', 'mouseleave', 'play'].forEach(event => {
		video.addEventListener(event, () => updateAudioStatus(video));
	});
	
	let stuckTimeout;
    video.addEventListener('waiting', () => {
		console.log('Video waiting:', video.id);
        clearTimeout(stuckTimeout);
        stuckTimeout = setTimeout(() => reloadStream(video,i), 5000); // If stuck 5 sec
    });

    video.addEventListener('stalled', () => {
        console.log('Video stalled:', video.id);
        clearTimeout(stuckTimeout);
        stuckTimeout = setTimeout(() => reloadStream(video,i), 5000);
    });

    video.addEventListener('error', () => {
        console.log('Video error:', video.id);
        reloadStream(video,i);
    });

    video.addEventListener('playing', () => {
        clearTimeout(stuckTimeout); // Clear if video starts playing
    });

	const container = video.closest('.video-wrapper');
	const canvas = container.querySelector('canvas');
	var flag = false
	setInterval(captureFrame, THROTTLE_INTERVAL, container, canvas, video);
	container.addEventListener('mouseenter', () => {
		hoverTimeout = setTimeout(() =>{
			container.style.cursor = '';
			canvas.classList.remove('active');
		flag = true;
		}, 700)
	});
	container.addEventListener('mouseleave', () => {
		clearTimeout(hoverTimeout);
		if (flag) {
		setTimeout(() =>{
		captureFrame(container, canvas, video); // take snapshot immediately
		}, 700)
		flag = false;
		}

	});
	video.addEventListener('loadeddata', () => {
		setTimeout(() => captureFrame(container, canvas, video), 50); // slight delay to ensure frame available
		const rect = video.getBoundingClientRect();
		canvas.width = rect.width;
		canvas.height = rect.height;
	});
}
</script>
</body>
</html>
